{% extends "SindilojasCobrancaBundle::layout.html.twig" %}
{% form_theme form 'SindilojasCobrancaBundle:Form:fields.html.twig' %}
{% form_theme form.dividas 'SindilojasCobrancaBundle:Form:dividas.html.twig' %}
{% block head %}
    <script src="{{ asset('bundles/sindilojas/js/jquery.validate.min.js') }}"></script>
    <script src="{{ asset('bundles/sindilojas/js/messages_ptbr.js') }}"></script>
    <script src="{{ asset('bundles/sindilojas/js/validate/additional-methods.js') }}"></script>
    <script src="{{ asset('bundles/sindilojas/js/jquery.maskedinput.min.js') }}"></script>
    <script src="{{ asset('bundles/sindilojas/js/jquery.maskMoney.js') }}"></script>
    <script src="{{ asset('bundles/sindilojas/js/jquery-ui-1.10.3.min.js') }}"></script>
    <script>
        jQuery(document).ready(function(){
            jQuery("#cliente_cpf").mask("999.999.999-99");
            jQuery("#cliente_nascimento").mask("99/99/9999").datepicker();;
            jQuery("#cliente_telefone").mask("(99) 9999-9999?9");
            jQuery("#cliente_cep").mask("99999-999", 
                {completed:function(){
                    jQuery.getScript('http://cep.republicavirtual.com.br/web_cep.php?formato=javascript&cep='+this.val(), function(data){
                        jQuery('#cliente_uf').val(unescape(resultadoCEP.uf));
                        jQuery('#cliente_cidade').val(unescape(resultadoCEP.cidade));
                        jQuery('#cliente_bairro').val(unescape(resultadoCEP.bairro));
                        jQuery('#cliente_rua').val(unescape(resultadoCEP.tipo_logradouro)+' '+unescape(resultadoCEP.logradouro));
                        if(jQuery('#cliente_uf').val()==''){
                            alert('CEP Inválido');
                            jQuery("#cliente_cep").val('');
                        }
                    })
                }}
            );
            jQuery("#basicForm").validate({
                rules: {
                    "cliente[cpf]":         {cpf: true},
                    "cliente[email]":       {email: true},
                    "cliente[nascimento]":  {brazilianDate: true}
                },
                highlight: function(element) {
                    jQuery(element).closest('.form-group').removeClass('has-success').addClass('has-error');
                },
                success: function(element) {
                    jQuery(element).closest('.form-group').removeClass('has-error');
                },
                submitHandler: function(form) {
                    for(var i=0; i>dividaCount; i++) {
                        
                        jQuery("#cliente_dividas_"+i+"_valor").maskMoney({thousands:'.', decimal:','});
                    }
                    jQuery('#cliente_cidade, #cliente_uf').removeAttr('disabled');
                    form.submit();
               }
            });
            var dividaCount = '{{ form.dividas|length }}';
            
            for(var i=dividaCount; i>0;) {
                i--;
                jQuery("#cliente_dividas_"+i+"_vencimento").mask("99/99/9999").datepicker();
                jQuery("#cliente_dividas_"+i+"_valor").maskMoney({thousands:'.', decimal:','});
                jQuery("#cliente_dividas_"+i+"_valor").maskMoney("mask");
            }
            
            
            jQuery('#add-divida').click(function(e) {
                e.preventDefault();

                var dividas = jQuery('#dividas');

                // grab the prototype template
                var newWidget = dividas.attr('data-prototype');
                // replace the "__name__" used in the id and name of the prototype
                // with a number that's unique to your emails
                // end name attribute looks like name="contact[emails][2]"
                newWidget = newWidget.replace(/__name__/g, dividaCount);
                
                jQuery(newWidget).insertBefore(jQuery(this));
                jQuery("#cliente_dividas_"+dividaCount+"_vencimento").mask("99/99/9999").datepicker();
                jQuery("#cliente_dividas_"+dividaCount+"_valor").maskMoney({prefix:'R$ ', thousands:'.', decimal:',', affixesStay: true});
                dividaCount++;
            });
        });
    </script>
{% endblock %}

{% block mainpanel %}
<div class="pageheader">
    <div class="media">
        <div class="pageicon pull-left">
            <i class="fa fa-pencil"></i>
        </div>
        <div class="media-body">
            <ul class="breadcrumb">
                <li><a href=""><i class="glyphicon glyphicon-home"></i></a></li>
                <li><a href="">Clientes</a></li>
                <li>Cadastrar Cliente</li>
            </ul>
            <h4>Cadastrar Cliente</h4>
        </div>
    </div><!-- media -->
</div><!-- pageheader -->


    <div class="row">
        <div class="col-md-12">
            <form method="POST" class="form-horizontal form-bordered" id="basicForm" action="">
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="row">
                        {{ form_row(form.nome) }}
                        {{ form_row(form.cpf) }}
                        {{ form_row(form.rg) }}
                        {{ form_row(form.cep) }}
                        {{ form_row(form.uf) }}
                        {{ form_row(form.cidade) }}
                        {{ form_row(form.bairro) }}
                        {{ form_row(form.rua) }}
                        {{ form_row(form.numero) }}
                        {{ form_row(form.complemento) }}
                        {{ form_row(form.email) }}
                        {{ form_row(form.telefone) }}
                        {{ form_row(form.nascimento) }}
                        <div id="dividas" data-prototype="{{ form_row(form.dividas.vars.prototype)|e  }}" class="dividas"></div>
                        {% for divida in form.dividas %}
                            {{ form_row(divida) }}
                        {% endfor %}                        
                        <a id="add-divida" href="#dividas">Adicionar dívida</a>
                        {{ form_row(form._token) }}
                        {{ form_errors(form) }}
                    </div><!-- row -->
                </div><!-- panel-body -->
                <div class="panel-footer">
                  <div class="row">
                    <div class="col-sm-9 col-sm-offset-3">
                        <button class="btn btn-primary mr5">Salvar</button>
                        <button type="reset" class="btn btn-dark">Limpar</button>
                    </div>
                  </div>
                </div><!-- panel-footer -->  
            </div><!-- panel -->
            </form>

        </div><!-- col-md-6 -->

    </div><!--row -->


</div><!-- contentpanel -->
{% endblock %}